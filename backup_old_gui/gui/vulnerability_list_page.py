#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ì·¨ì•½ì  ëª©ë¡ íŽ˜ì´ì§€
"""

from PyQt5.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QLabel, 
                             QPushButton, QTableWidget, QTableWidgetItem,
                             QProgressBar, QMessageBox, QSplitter, QTextEdit,
                             QFrame, QHeaderView)
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QTimer
from PyQt5.QtGui import QFont, QColor, QBrush
import time

class ScanThread(QThread):
    """ìŠ¤ìº” ìŠ¤ë ˆë“œ"""
    scan_progress = pyqtSignal(int, str)
    scan_complete = pyqtSignal(list)
    
    def __init__(self, target_ip):
        super().__init__()
        self.target_ip = target_ip
        
    def run(self):
        # ìŠ¤ìº” ì§„í–‰ ì‹œë®¬ë ˆì´ì…˜
        scan_steps = [
            "í¬íŠ¸ ìŠ¤ìº” ì¤‘...",
            "ì„œë¹„ìŠ¤ ë²„ì „ ê°ì§€ ì¤‘...",
            "OS ì •ë³´ ìˆ˜ì§‘ ì¤‘...",
            "ì·¨ì•½ì  ë°ì´í„°ë² ì´ìŠ¤ ê²€ìƒ‰ ì¤‘...",
            "ì·¨ì•½ì  í™•ì¸ ì¤‘...",
            "ê²°ê³¼ ë¶„ì„ ì¤‘..."
        ]
        
        for i, step in enumerate(scan_steps, 1):
            self.scan_progress.emit(i * 100 // len(scan_steps), step)
            time.sleep(1)
            
        # ìƒ˜í”Œ ì·¨ì•½ì  ë°ì´í„° ìƒì„±
        vulnerabilities = [
            {
                "id": "CVE-2017-0144",
                "name": "MS17-010 EternalBlue",
                "description": "SMB í”„ë¡œí† ì½œì˜ ì›ê²© ì½”ë“œ ì‹¤í–‰ ì·¨ì•½ì ",
                "severity": "Critical",
                "port": 445,
                "service": "SMB",
                "status": "Vulnerable",
                "exploit_available": True,
                "exploit_module": "exploit/windows/smb/ms17_010_eternalblue"
            },
            {
                "id": "CVE-2008-4250",
                "name": "MS08-067 NetAPI",
                "description": "Server Serviceì˜ ìƒëŒ€ ê²½ë¡œ ìŠ¤íƒ ì†ìƒ ì·¨ì•½ì ",
                "severity": "Critical",
                "port": 445,
                "service": "SMB",
                "status": "Not Vulnerable",
                "exploit_available": True,
                "exploit_module": "exploit/windows/smb/ms08_067_netapi"
            },
            {
                "id": "CVE-2010-2729",
                "name": "MS10-061 Print Spooler",
                "description": "Print Spooler ì„œë¹„ìŠ¤ì˜ ê°€ìž¥ ì·¨ì•½ì ",
                "severity": "High",
                "port": 135,
                "service": "RPC",
                "status": "Vulnerable",
                "exploit_available": True,
                "exploit_module": "exploit/windows/smb/ms10_061_spoolss"
            },
            {
                "id": "CVE-2014-0160",
                "name": "Heartbleed",
                "description": "OpenSSLì˜ Heartbeat í™•ìž¥ ì·¨ì•½ì ",
                "severity": "High",
                "port": 443,
                "service": "HTTPS",
                "status": "Not Vulnerable",
                "exploit_available": True,
                "exploit_module": "auxiliary/scanner/ssl/openssl_heartbleed"
            },
            {
                "id": "CVE-2012-1823",
                "name": "PHP CGI Argument Injection",
                "description": "PHP CGIì˜ ì¸ìˆ˜ ì£¼ìž… ì·¨ì•½ì ",
                "severity": "Medium",
                "port": 80,
                "service": "HTTP",
                "status": "Vulnerable",
                "exploit_available": True,
                "exploit_module": "exploit/multi/http/php_cgi_arg_injection"
            },
            {
                "id": "CVE-2014-6271",
                "name": "Shellshock",
                "description": "Bashì˜ í™˜ê²½ ë³€ìˆ˜ ì²˜ë¦¬ ì·¨ì•½ì ",
                "severity": "High",
                "port": 80,
                "service": "HTTP",
                "status": "Not Vulnerable",
                "exploit_available": True,
                "exploit_module": "exploit/multi/http/apache_mod_cgi_bash_env_exec"
            }
        ]
        
        self.scan_complete.emit(vulnerabilities)

class VulnerabilityListPage(QWidget):
    """ì·¨ì•½ì  ëª©ë¡ íŽ˜ì´ì§€"""
    
    def __init__(self, target_ip):
        super().__init__()
        self.target_ip = target_ip
        self.vulnerabilities = []
        self.selected_vulnerability = None
        self.init_ui()
        self.start_scan()
        
    def init_ui(self):
        """UI ì´ˆê¸°í™”"""
        layout = QVBoxLayout(self)
        
        # ì œëª©
        title_label = QLabel(f"ðŸ” {self.target_ip} ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼")
        title_label.setFont(QFont("Arial", 16, QFont.Bold))
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("color: #2c3e50; padding: 20px;")
        layout.addWidget(title_label)
        
        # ìŠ¤ìº” ì§„í–‰ë¥ 
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        layout.addWidget(self.progress_bar)
        
        # ìƒíƒœ ë©”ì‹œì§€
        self.status_label = QLabel("ìŠ¤ìº”ì„ ì‹œìž‘í•©ë‹ˆë‹¤...")
        self.status_label.setAlignment(Qt.AlignCenter)
        self.status_label.setStyleSheet("color: #3498db; padding: 10px; font-weight: bold;")
        layout.addWidget(self.status_label)
        
        # ë©”ì¸ ìŠ¤í”Œë¦¬í„°
        splitter = QSplitter(Qt.Horizontal)
        
        # ì™¼ìª½ - ì·¨ì•½ì  ëª©ë¡
        left_panel = self.create_vulnerability_list_panel()
        splitter.addWidget(left_panel)
        
        # ì˜¤ë¥¸ìª½ - ìƒì„¸ ì •ë³´
        right_panel = self.create_detail_panel()
        splitter.addWidget(right_panel)
        
        splitter.setSizes([600, 400])
        layout.addWidget(splitter)
        
        # í•˜ë‹¨ ë²„íŠ¼ë“¤
        button_layout = QHBoxLayout()
        
        self.refresh_btn = QPushButton("ðŸ”„ ìƒˆë¡œê³ ì¹¨")
        self.refresh_btn.clicked.connect(self.start_scan)
        self.refresh_btn.setStyleSheet("""
            QPushButton {
                background-color: #3498db;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
            }
            QPushButton:hover {
                background-color: #2980b9;
            }
        """)
        button_layout.addWidget(self.refresh_btn)
        
        self.hack_btn = QPushButton("âš¡ ëª¨ì˜í•´í‚¹ ì‹œìž‘")
        self.hack_btn.clicked.connect(self.start_hacking)
        self.hack_btn.setEnabled(False)
        self.hack_btn.setStyleSheet("""
            QPushButton {
                background-color: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #c0392b;
            }
            QPushButton:disabled {
                background-color: #bdc3c7;
            }
        """)
        button_layout.addWidget(self.hack_btn)
        
        button_layout.addStretch()
        
        self.back_btn = QPushButton("â† ë’¤ë¡œê°€ê¸°")
        self.back_btn.clicked.connect(self.go_back)
        self.back_btn.setStyleSheet("""
            QPushButton {
                background-color: #95a5a6;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
            }
            QPushButton:hover {
                background-color: #7f8c8d;
            }
        """)
        button_layout.addWidget(self.back_btn)
        
        layout.addLayout(button_layout)
        
    def create_vulnerability_list_panel(self):
        """ì·¨ì•½ì  ëª©ë¡ íŒ¨ë„ ìƒì„±"""
        frame = QFrame()
        frame.setFrameStyle(QFrame.StyledPanel)
        layout = QVBoxLayout(frame)
        
        # íŒ¨ë„ ì œëª©
        panel_title = QLabel("ðŸ“‹ ë°œê²¬ëœ ì·¨ì•½ì  ëª©ë¡")
        panel_title.setFont(QFont("Arial", 12, QFont.Bold))
        layout.addWidget(panel_title)
        
        # ì·¨ì•½ì  í…Œì´ë¸”
        self.vuln_table = QTableWidget()
        self.vuln_table.setColumnCount(6)
        self.vuln_table.setHorizontalHeaderLabels(["CVE ID", "ì·¨ì•½ì ëª…", "ìœ„í—˜ë„", "ìƒíƒœ", "í¬íŠ¸", "ì„œë¹„ìŠ¤"])
        
        # í…Œì´ë¸” ìŠ¤íƒ€ì¼ ì„¤ì •
        self.vuln_table.setStyleSheet("""
            QTableWidget {
                gridline-color: #bdc3c7;
                background-color: white;
                alternate-background-color: #f8f9fa;
            }
            QHeaderView::section {
                background-color: #34495e;
                color: white;
                padding: 8px;
                border: none;
                font-weight: bold;
            }
        """)
        
        # ì—´ ë„ˆë¹„ ì¡°ì •
        header = self.vuln_table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeToContents)  # CVE ID
        header.setSectionResizeMode(1, QHeaderView.Stretch)           # ì·¨ì•½ì ëª…
        header.setSectionResizeMode(2, QHeaderView.ResizeToContents)  # ìœ„í—˜ë„
        header.setSectionResizeMode(3, QHeaderView.ResizeToContents)  # ìƒíƒœ
        header.setSectionResizeMode(4, QHeaderView.ResizeToContents)  # í¬íŠ¸
        header.setSectionResizeMode(5, QHeaderView.ResizeToContents)  # ì„œë¹„ìŠ¤
        
        # í–‰ ì„ íƒ ì´ë²¤íŠ¸ ì—°ê²°
        self.vuln_table.itemSelectionChanged.connect(self.on_vulnerability_selected)
        
        layout.addWidget(self.vuln_table)
        
        return frame
        
    def create_detail_panel(self):
        """ìƒì„¸ ì •ë³´ íŒ¨ë„ ìƒì„±"""
        frame = QFrame()
        frame.setFrameStyle(QFrame.StyledPanel)
        layout = QVBoxLayout(frame)
        
        # íŒ¨ë„ ì œëª©
        panel_title = QLabel("ðŸ“„ ì·¨ì•½ì  ìƒì„¸ ì •ë³´")
        panel_title.setFont(QFont("Arial", 12, QFont.Bold))
        layout.addWidget(panel_title)
        
        # ìƒì„¸ ì •ë³´ í…ìŠ¤íŠ¸
        self.detail_text = QTextEdit()
        self.detail_text.setReadOnly(True)
        self.detail_text.setStyleSheet("""
            QTextEdit {
                background-color: #f8f9fa;
                border: 1px solid #bdc3c7;
                border-radius: 5px;
                padding: 10px;
                font-family: 'Courier New', monospace;
                font-size: 12px;
            }
        """)
        layout.addWidget(self.detail_text)
        
        return frame
        
    def start_scan(self):
        """ìŠ¤ìº” ì‹œìž‘"""
        self.progress_bar.setVisible(True)
        self.progress_bar.setValue(0)
        self.status_label.setText("ìŠ¤ìº”ì„ ì‹œìž‘í•©ë‹ˆë‹¤...")
        self.status_label.setStyleSheet("color: #3498db; padding: 10px; font-weight: bold;")
        self.refresh_btn.setEnabled(False)
        self.hack_btn.setEnabled(False)
        
        # ìŠ¤ìº” ìŠ¤ë ˆë“œ ì‹œìž‘
        self.scan_thread = ScanThread(self.target_ip)
        self.scan_thread.scan_progress.connect(self.on_scan_progress)
        self.scan_thread.scan_complete.connect(self.on_scan_complete)
        self.scan_thread.start()
        
    def on_scan_progress(self, progress, message):
        """ìŠ¤ìº” ì§„í–‰ë¥  ì—…ë°ì´íŠ¸"""
        self.progress_bar.setValue(progress)
        self.status_label.setText(message)
        
    def on_scan_complete(self, vulnerabilities):
        """ìŠ¤ìº” ì™„ë£Œ"""
        self.vulnerabilities = vulnerabilities
        self.progress_bar.setVisible(False)
        self.status_label.setText(f"âœ… ìŠ¤ìº” ì™„ë£Œ! {len(vulnerabilities)}ê°œì˜ ì·¨ì•½ì ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.")
        self.status_label.setStyleSheet("color: #27ae60; padding: 10px; font-weight: bold;")
        self.refresh_btn.setEnabled(True)
        
        # í…Œì´ë¸”ì— ë°ì´í„° ì¶”ê°€
        self.populate_vulnerability_table()
        
    def populate_vulnerability_table(self):
        """ì·¨ì•½ì  í…Œì´ë¸”ì— ë°ì´í„° ì¶”ê°€"""
        self.vuln_table.setRowCount(len(self.vulnerabilities))
        
        for i, vuln in enumerate(self.vulnerabilities):
            # CVE ID
            cve_item = QTableWidgetItem(vuln['id'])
            self.vuln_table.setItem(i, 0, cve_item)
            
            # ì·¨ì•½ì ëª…
            name_item = QTableWidgetItem(vuln['name'])
            self.vuln_table.setItem(i, 1, name_item)
            
            # ìœ„í—˜ë„
            severity_item = QTableWidgetItem(vuln['severity'])
            if vuln['severity'] == 'Critical':
                severity_item.setBackground(QBrush(QColor(231, 76, 60, 100)))  # ë¹¨ê°„ìƒ‰
            elif vuln['severity'] == 'High':
                severity_item.setBackground(QBrush(QColor(243, 156, 18, 100)))  # ì£¼í™©ìƒ‰
            else:
                severity_item.setBackground(QBrush(QColor(46, 204, 113, 100)))  # ì´ˆë¡ìƒ‰
            self.vuln_table.setItem(i, 2, severity_item)
            
            # ìƒíƒœ
            status_item = QTableWidgetItem(vuln['status'])
            if vuln['status'] == 'Vulnerable':
                status_item.setBackground(QBrush(QColor(231, 76, 60, 100)))  # ë¹¨ê°„ìƒ‰
            else:
                status_item.setBackground(QBrush(QColor(46, 204, 113, 100)))  # ì´ˆë¡ìƒ‰
            self.vuln_table.setItem(i, 3, status_item)
            
            # í¬íŠ¸
            port_item = QTableWidgetItem(str(vuln['port']))
            self.vuln_table.setItem(i, 4, port_item)
            
            # ì„œë¹„ìŠ¤
            service_item = QTableWidgetItem(vuln['service'])
            self.vuln_table.setItem(i, 5, service_item)
            
    def on_vulnerability_selected(self):
        """ì·¨ì•½ì  ì„ íƒ ì‹œ í˜¸ì¶œ"""
        current_row = self.vuln_table.currentRow()
        if current_row >= 0 and current_row < len(self.vulnerabilities):
            vuln = self.vulnerabilities[current_row]
            self.selected_vulnerability = vuln
            
            # ìƒì„¸ ì •ë³´ í‘œì‹œ
            detail_text = f"""
CVE ID: {vuln['id']}
ì´ë¦„: {vuln['name']}
ì„¤ëª…: {vuln['description']}
ìœ„í—˜ë„: {vuln['severity']}
í¬íŠ¸: {vuln['port']}
ì„œë¹„ìŠ¤: {vuln['service']}
ìƒíƒœ: {vuln['status']}
ìµìŠ¤í”Œë¡œìž‡ ê°€ëŠ¥: {'ì˜ˆ' if vuln['exploit_available'] else 'ì•„ë‹ˆì˜¤'}

"""
            
            if vuln['exploit_available']:
                detail_text += f"ìµìŠ¤í”Œë¡œìž‡ ëª¨ë“ˆ: {vuln['exploit_module']}\n"
                
            if vuln['status'] == 'Vulnerable':
                detail_text += "\nâš ï¸ ì´ ì·¨ì•½ì ì€ ëª¨ì˜í•´í‚¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."
                
            self.detail_text.setPlainText(detail_text)
            
            # ëª¨ì˜í•´í‚¹ ë²„íŠ¼ í™œì„±í™” (ì·¨ì•½í•œ ì·¨ì•½ì ë§Œ)
            if vuln['status'] == 'Vulnerable' and vuln['exploit_available']:
                self.hack_btn.setEnabled(True)
            else:
                self.hack_btn.setEnabled(False)
                
    def start_hacking(self):
        """ëª¨ì˜í•´í‚¹ ì‹œìž‘"""
        if not self.selected_vulnerability:
            QMessageBox.warning(self, "ê²½ê³ ", "ëª¨ì˜í•´í‚¹í•  ì·¨ì•½ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return
            
        vuln = self.selected_vulnerability
        
        # ê²½ê³  ë©”ì‹œì§€
        reply = QMessageBox.question(self, "ëª¨ì˜í•´í‚¹ í™•ì¸", 
                                   f"'{vuln['name']}' ì·¨ì•½ì ìœ¼ë¡œ ëª¨ì˜í•´í‚¹ì„ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n"
                                   "âš ï¸ ì´ëŠ” êµìœ¡ ëª©ì ì˜ ëª¨ì˜í•´í‚¹ìž…ë‹ˆë‹¤.\n"
                                   "ì‹¤ì œ ì‹œìŠ¤í…œì— ëŒ€í•œ ë¬´ë‹¨ ì ‘ê·¼ì€ ë²•ì  ë¬¸ì œë¥¼ ì•¼ê¸°í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.",
                                   QMessageBox.Yes | QMessageBox.No,
                                   QMessageBox.No)
        
        if reply == QMessageBox.Yes:
            # ëª¨ì˜í•´í‚¹ íŽ˜ì´ì§€ë¡œ ì´ë™
            self.start_simulation_hacking(vuln)
            
    def start_simulation_hacking(self, vulnerability):
        """ëª¨ì˜í•´í‚¹ ì‹œë®¬ë ˆì´ì…˜ ì‹œìž‘"""
        # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ë©”ì‹œì§€ ë°•ìŠ¤ë¡œ ëŒ€ì²´
        # ì‹¤ì œë¡œëŠ” ëª¨ì˜í•´í‚¹ íŽ˜ì´ì§€ë¡œ ì´ë™í•´ì•¼ í•¨
        QMessageBox.information(self, "ëª¨ì˜í•´í‚¹ ì‹œìž‘", 
                              f"'{vulnerability['name']}' ëª¨ì˜í•´í‚¹ì„ ì‹œìž‘í•©ë‹ˆë‹¤.\n\n"
                              "ì´ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •ìž…ë‹ˆë‹¤.")
        
    def go_back(self):
        """ë’¤ë¡œê°€ê¸°"""
        parent = self.parent()
        if parent and hasattr(parent, 'show_main_page'):
            parent.show_main_page()
        elif parent and hasattr(parent, 'stacked_widget'):
            # MainWindowê°€ ì•„ë‹ˆê±°ë‚˜ show_main_pageê°€ ì—†ì„ ë•Œ ìŠ¤íƒ ì²« íŽ˜ì´ì§€ë¡œ ì´ë™
            parent.stacked_widget.setCurrentIndex(0)
        else:
            # ë¶€ëª¨ê°€ ì—†ê±°ë‚˜ ì˜ˆì™¸ ìƒí™©ì¼ ë•Œ ë¬´ì‹œ
            pass
